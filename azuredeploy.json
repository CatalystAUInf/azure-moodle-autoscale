{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "administratorLogin": {
            "defaultValue": "postgresadmin",
            "metadata": {
                "description": "postgresql admin username"
            },
            "type": "string"
        },
        "administratorLoginPassword": {
            "metadata": {
                "description": "postgresql admin password"
            },
            "type": "securestring"
        },
        "adminPassword": {
            "metadata": {
                "description": "ssh password"
            },
            "type": "securestring"
        },
        "adminUsername": {
            "defaultValue": "azureadmin",
            "metadata": {
                "description": "ssh user name"
            },
            "type": "string"
        },
        "applyScriptsSwitch": {
            "allowedValues": [
                0,
                1
            ],
            "defaultValue": 0,
            "metadata": {
                "description": "Switch to process or bypass all scripts/extensions"
            },
            "type": "int"
        },
        "azureBackupSwitch": {
            "allowedValues": [
                0,
                1
            ],
            "defaultValue": 0,
            "metadata": {
                "description": "Switch to configure AzureBackup and enlist VM's"
            },
            "type": "int"
        },
        "firewallRuleName": {
            "defaultValue": "all_private_ip_range",
            "metadata": {
                "description": "Postgres firewall rule name"
            },
            "type": "string"
        },
        "firewallStartIpAddress": {
            "defaultValue": "172.31.0.0",
            "metadata": {
                "description": "Postgres firewall start ip address"
            },
            "type": "string"
        },
        "firewallEndIpAddress": {
            "defaultValue": "172.31.255.255",
            "metadata": {
                "description": "Postgres firewall end ip address"
            },
            "type": "string"
        },
        "glusterTshirtSize": {
            "allowedValues": [
                "Small",
                "Medium",
                "Large"
            ],
            "defaultValue": "Small",
            "metadata": {
                "description": "VM size for the gluster nodes"
            },
            "type": "string"
        },
        "location": {
            "allowedValues": [
                "East Asia",
                "East US 2",
                "East US",
                "Japan East",
                "Japan West",
                "North Central US",
                "North Europe",
                "South Central US",
                "Southeast Asia",
                "West Europe",
                "West US"
            ],
            "defaultValue": "West US",
            "metadata": {
                "description": "Postgresql server location"
            },
            "type": "string"
        },
        "moodleVersion": {
            "allowedValues": [
		"MOODLE_34_STABLE",
                "MOODLE_33_STABLE",
                "MOODLE_32_STABLE",
                "MOODLE_31_STABLE",
                "MOODLE_30_STABLE",
                "MOODLE_29_STABLE"
            ],
            "defaultValue": "MOODLE_34_STABLE",
            "metadata": {
                "description": "The Moodle version you want to install."
            },
            "type": "string"
        },
        "resourcesPrefix": {
            "defaultValue": "idontknow",
            "metadata": {
                "description": "Prefix of storage account name, network, virtual machines, and so on"
            },
            "type": "string"
        },
        "skuCapacityDTU": {
            "allowedValues": [
                50,
                100
            ],
            "defaultValue": 50,
            "metadata": {
                "description": "Postgresql database trasaction units"
            },
            "type": "int"
        },
        "skuFamily": {
            "allowedValues": [
                "SkuFamily"
            ],
            "defaultValue": "SkuFamily",
            "metadata": {
                "description": "Postgresql sku family"
            },
            "type": "string"
        },
        "skuName": {
            "allowedValues": [
                "PGSQLB50",
                "PGSQLB100"
            ],
            "defaultValue": "PGSQLB50",
            "metadata": {
                "description": "Postgresql sku name"
            },
            "type": "string"
        },
        "skuSizeMB": {
            "defaultValue": 51200,
            "metadata": {
                "description": "Postgresql sku size in mb"
            },
            "type": "int"
        },
        "skuTier": {
            "allowedValues": [
                "Basic"
            ],
            "defaultValue": "Basic",
            "metadata": {
                "description": "Postgresql sku tier"
            },
            "type": "string"
        },
        "version": {
            "allowedValues": [
                "9.5",
                "9.6"
            ],
            "defaultValue": "9.6",
            "metadata": {
                "description": "Postgresql version"
            },
            "type": "string"
        },
        "vNetAddressSpace": {
            "defaultValue": "172.31.0.0",
            "metadata": {
                "description": "Address range for the Moodle virtual network - presumed /16 - further subneting during vnet creation"
            },
            "type": "string"
        }
    },
    "resources": [
        {
            "apiVersion": "2015-01-01",
            "name": "postgresTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'postgres.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "name": "recoveryTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'recoveryservices',variables('moodleCommon').azureBackupSwitch,'.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "name": "redisTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'redis.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "name": "networkTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'network.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate"
            ],
            "name": "glusterTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'gluster.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/glusterTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate"
            ],
            "name": "ControllerTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'controller.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/controllerTemplate",
                "Microsoft.Resources/deployments/redisTemplate",
                "Microsoft.Resources/deployments/postgresTemplate"
            ],
            "name": "ScaleSetTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'webvmss.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        }
    ],
    "variables": {
        "documentation01": "This main-template calls multiple sub-templates to create the moodle system",
        "documentation02": "    recoveryservices0 - dummy template (see next statement)",
        "documentation03": "    recoveryservices1 - creates a recovery vault that will be subsequently used by the VM Backup - a paramter swtich controls whethe is is called or bypassed",
        "documentation04": "    redis             - creates a redis cache",
        "documentation05": "    postgresql        - creates a postgresql server",
        "documentation06": "    vnet              - creates a virtual network with three subnets",
        "documentation07": "    gluster           - creates a gluster file system on a vm farm",
        "documentation08": "    webvmss           - creates a vm scale set",
        "documentation09": "    controller        - creates a jumpbox and deploys code",
        "documentation10": "GlusterFS Sizing guidance",
        "documentation11": "Small - small number of courses, low interactiviness in the courses, low IOPSs required",
        "documentation12": "Medium - interactive courses, with uploads; medium number of IOPS required",
        "documentation13": "Large - very interactive courses, highly concurrent or high number of courses in the same environemnt; burst IOPS required, during certain period of time",
        "moodleCommon": {
            "administratorLogin": "[parameters('administratorLogin')]",
            "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
            "adminPassword": "[parameters('adminPassword')]",
            "adminUsername": "[parameters('adminUsername')]",
            "applyScriptsSwitch": "[parameters('applyScriptsSwitch')]",
            "azureBackupSwitch": "[parameters( 'azureBackupSwitch')]",
            "baseTemplateUrl": "https://git.catalyst-au.net/internal/azure/raw/master/nested/",
            "computeApi": "2016-04-30-preview",
            "extBeName": "[concat('lb-',variables('rpfx'),'-backend')]",
            "extFeName": "[concat('lb-',variables('rpfx'),'-frontend')]",
            "extNatPool": "[concat('lb-',variables('rpfx'),'-natpool')]",
            "extProbe": "[concat('lb-',variables('rpfx'),'-probe')]",
            "firewallRuleName": "[parameters('firewallRuleName')]",
            "firewallStartIpAddress": "[parameters('firewallStartIpAddress')]",
            "firewallEndIpAddress": "[parameters('firewallEndIpAddress')]",
            "gfsNameRoot": "[concat('gluster-',variables('rpfx'),'-vm')]",
            "gfxAvailabilitySetName": "[concat('gluster-',variables('rpfx'),'-as')]",
            "glusterScriptFilename": "install_gluster.sh",
            "glusterTshirtSize": "[parameters('glusterTshirtSize')]",
            "glusterVmCount": 2,
            "jboxNicName": "[concat('jumpbox-',variables('rpfx'),'-vm-nic')]",
            "jboxNsgName": "[concat('jumpbox-',variables('rpfx'),'-nsg')]",
            "jboxPipName": "[concat('jumpbox-',variables('rpfx'))]",
            "jboxVmName": "[concat('jumpbox-',variables('rpfx'),'-vm')]",
            "lbDnsName": "[concat('lb-',variables('rpfx'))]",
            "lbName": "[concat('lb-',variables('rpfx'))]",
            "lbPipName": "[concat('lb-',variables('rpfx'),'-ip')]",
            "location": "[parameters('location')]",
            "moodleInstallScriptFilename": "install_moodle.sh",
            "moodleSetupScriptFilename": "setup_moodle.sh",
            "moodleVersion": "[parameters('moodleVersion')]",
            "osType": {
                "offer": "UbuntuServer",
                "publisher": "Canonical",
                "sku": "16.04-LTS",
                "version": "latest"
            },
            "policyName": "[concat('policy-',variables('rpfx'))]",
            "redisCacheName": "[concat('redis-',variables('rpfx'))]",
            "resourcesPrefix": "[variables('rpfx')]",
            "scriptLocation": "../scripts/",
            "serverName": "[concat('postgres-',variables('rpfx'))]",
            "skuCapacityDTU": "[parameters('skuCapacityDTU')]",
            "skuFamily": "[parameters('skuFamily')]",
            "skuName": "[parameters('skuName')]",
            "skuSizeMB": "[parameters('skuSizeMB')]",
            "skuTier": "[parameters('skuTier')]",
            "subnetDb": "[concat('data-',variables('rpfx'),'-subnet')]",
            "subnetDbPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)))]",
            "subnetDbRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)), '.0/24')]",
            "subnetSan": "[concat('san-',variables('rpfx'),'-subnet')]",
            "subnetSanPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)))]",
            "subnetSanRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)), '.0/24')]",
            "subnetWeb": "[concat('web-',variables('rpfx'),'-subnet')]",
            "subnetWebPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)))]",
            "subnetWebRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)), '.0/24')]",
            "vNetAddressSpace": "[parameters('vNetAddressSpace')]",
            "vaultName": "[concat(variables('rpfx'),'-vault')]",
            "version": "[parameters('version')]",
            "vmssName": "[concat('vmss-',variables('rpfx'))]",
            "vmssdStorageAccounttName": "[concat('vmss',uniqueString(resourceGroup().id))]",
            "vnetName": "[concat('vnet-',variables('rpfx'))]"
        },
        "octets": "[split(parameters('vNetAddressSpace'), '.')]",
        "rpfx": "[tolower(parameters('resourcesPrefix'))]"
    }
}
