{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminPassword": {
            "metadata": {
                "description": "ssh password"
            },
            "type": "securestring"
        },
        "adminUsername": {
            "defaultValue": "azureadmin",
            "metadata": {
                "description": "ssh user name"
            },
            "type": "string"
        },
        "applyScriptsSwitch": {
            "allowedValues": [
                0,
                1
            ],
            "defaultValue": 0,
            "metadata": {
                "description": "Switch to process or bypass all scripts/extensions"
            },
            "type": "int"
        },
        "azureBackupSwitch": {
            "allowedValues": [
                0,
                1
            ],
            "defaultValue": 0,
            "metadata": {
                "description": "Switch to configure AzureBackup and enlist VM's"
            },
            "type": "int"
        },
        "glusterTshirtSize": {
            "allowedValues": [
                "Small",
                "Medium",
                "Large"
            ],
            "defaultValue": "Small",
            "metadata": {
                "description": "VM size for the gluster nodes"
            },
            "type": "string"
        },
        "moodleVersion": {
            "allowedValues": [
		"MOODLE_34_STABLE",
                "MOODLE_33_STABLE",
                "MOODLE_32_STABLE",
                "MOODLE_31_STABLE",
                "MOODLE_30_STABLE",
                "MOODLE_29_STABLE"
            ],
            "defaultValue": "MOODLE_32_STABLE",
            "metadata": {
                "description": "The Moodle version you want to install."
            },
            "type": "string"
        },
        "resourcesPrefix": {
            "defaultValue": "changeme",
            "metadata": {
                "description": "Prefix of storage account name, network, virtual machines, and so on"
            },
            "type": "string"
        },
        "vNetAddressSpace": {
            "defaultValue": "172.31.0.0",
            "metadata": {
                "description": "Address range for the Moodle virtual network - presumed /16 - further subneting during vnet creation"
            },
            "type": "string"
        }
    },
    "resources": [
        {
            "apiVersion": "2015-01-01",
            "name": "recoveryTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'recoveryservices',variables('moodleCommon').azureBackupSwitch,'.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "name": "redisTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'redis.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "name": "networkTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'network.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate"
            ],
            "name": "glusterTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'gluster.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/glusterTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate"
            ],
            "name": "ControllerTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'controller.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        },
        {
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/controllerTemplate",
                "Microsoft.Resources/deployments/redisTemplate"
            ],
            "name": "ScaleSetTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'webvmss.json')]"
                }
            },
            "type": "Microsoft.Resources/deployments"
        }
    ],
    "variables": {
        "documentation01": "This main-template calls multiple sub-templates to create the moodle system",
        "documentation02": "    recoveryservices0 - dummy template (see next statement)",
        "documentation03": "    recoveryservices1 - creates a recovery vault that will be subsequently used by the VM Backup - a paramter swtich controls whethe is is called or bypassed",
        "documentation04": "    redis             - creates a redis cache",
        "documentation05": "    vnet              - creates a virtual network with three subnets",
        "documentation06": "    gluster           - creates a gluster file system on a vm farm",
        "documentation08": "    webvmss           - creates a vm scale set",
        "documentation09": "    controller        - creates a jumpbox and deploys code",
        "documentation10": "GlusterFS Sizing guidance",
        "documentation11": "Small - small number of courses, low interactiviness in the courses, low IOPSs required",
        "documentation12": "Medium - interactive courses, with uploads; medium number of IOPS required",
        "documentation13": "Large - very interactive courses, highly concurrent or high number of courses in the same environemnt; burst IOPS required, during certain period of time",
        "moodleCommon": {
            "adminPassword": "[parameters('adminPassword')]",
            "adminUsername": "[parameters('adminUsername')]",
            "applyScriptsSwitch": "[parameters('applyScriptsSwitch')]",
            "azureBackupSwitch": "[parameters( 'azureBackupSwitch')]",
            "baseTemplateUrl": "https://git.catalyst-au.net/internal/azure/raw/master/nested/",
            "computeApi": "2016-04-30-preview",
            "extBeName": "[concat('lb-',variables('rpfx'),'-BE')]",
            "extFeName": "[concat('lb-',variables('rpfx'),'-FE')]",
            "extNatPool": "[concat('lb-',variables('rpfx'),'-NatPool')]",
            "extProbe": "[concat('lb-',variables('rpfx'),'-Probe')]",
            "gfsNameRoot": "[concat('gfs',variables('rpfx'),'vm')]",
            "gfxAvailabilitySetName": "[concat('gfs-',variables('rpfx'),'-as')]",
            "glusterScriptFilename": "install_gluster.sh",
            "glusterTshirtSize": "[parameters('glusterTshirtSize')]",
            "glusterVmCount": 2,
            "jboxNicName": "[concat('jbox',variables('rpfx'),'vm-nic')]",
            "jboxNsgName": "[concat('jbox',variables('rpfx'),'-nsg')]",
            "jboxPipName": "[concat('jbox',variables('rpfx'))]",
            "jboxVmName": "[concat('jbox',variables('rpfx'),'vm')]",
            "lbDnsName": "[concat('lb-',variables('rpfx'))]",
            "lbName": "[concat('lb-',variables('rpfx'))]",
            "lbPipName": "[concat('lb-',variables('rpfx'),'-ip')]",
            "moodleInstallScriptFilename": "install_moodle.sh",
            "moodleSetupScriptFilename": "setup_moodle.sh",
            "moodleVersion": "[parameters('moodleVersion')]",
            "osType": {
                "offer": "UbuntuServer",
                "publisher": "Canonical",
                "sku": "16.04-LTS",
                "version": "latest"
            },
            "policyName": "[concat(variables('rpfx'),'-policy')]",
            "redisCacheName": "[concat(variables('rpfx'),'-redis')]",
            "resourcesPrefix": "[variables('rpfx')]",
            "scriptLocation": "../scripts/",
            "subnetDb": "[concat('data-',variables('rpfx'),'-subnet')]",
            "subnetDbPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)))]",
            "subnetDbRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)), '.0/24')]",
            "subnetSan": "[concat('san-',variables('rpfx'),'-subnet')]",
            "subnetSanPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)))]",
            "subnetSanRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)), '.0/24')]",
            "subnetWeb": "[concat('web-',variables('rpfx'),'-subnet')]",
            "subnetWebPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)))]",
            "subnetWebRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)), '.0/24')]",
            "vNetAddressSpace": "[parameters('vNetAddressSpace')]",
            "vaultName": "[concat(variables('rpfx'),'-vault')]",
            "vmssName": "[concat('vmss',variables('rpfx'))]",
            "vmssdStorageAccounttName": "[concat('vmss',uniqueString(resourceGroup().id))]",
            "vnetName": "[concat(variables('rpfx'),'-vnet')]"
        },
        "octets": "[split(parameters('vNetAddressSpace'), '.')]",
        "rpfx": "[tolower(parameters('resourcesPrefix'))]"
    }
}
